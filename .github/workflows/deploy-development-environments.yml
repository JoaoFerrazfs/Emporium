name: Deploy by issue
permissions: write-all
on:
  issues:
    types: [opened]

jobs:
  deploy:
    if: contains(github.event.issue.labels.*.name, 'environment-deploy')
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Assign issue
        run: |
          gh issue edit ${{ github.event.issue.number }} --add-assignee ${{ github.event.issue.user.login }}
          gh issue comment ${{ github.event.issue.number }} -b "
            ‚åõ To follow the runner click here:
            - https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Parse issue
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/deploy-environments.yml

      - name: Issue branch validation
        run: |
          validatedIssueBranches=""
          branches="${{ steps.issue-parser.outputs.issueparser_branches }}"
          IFS=',' read -ra branch_array <<< "$branches"

          for branch in "${branch_array[@]}"; do
            set +e
            git ls-remote --exit-code --heads origin $branch &> /dev/null
            branch_exists=$?
            branch_merged=0

            if [[ "$branch_exists" == "0" ]]; then
              git fetch origin $branch &> /dev/null
              base_commit=$(git merge-base HEAD origin/master)
              branch_commit=$(git rev-parse origin/$branch)

              if [[ "$base_commit" != "$branch_commit" ]]; then
                branch_merged=1
              fi
            fi

            if [[ "$branch_exists" != "0" || "$branch_merged" != "0" ]]; then
              echo "error=Branch does not exist or has been merged: '$branch'" >> $GITHUB_ENV
              set -e
              exit 1
            fi

            validatedIssueBranches+="$branch,"
            echo "validatedIssueBranches=${validatedIssueBranches%,}" >> $GITHUB_ENV
          done

      - name: Close issue
        if: failure() && !cancelled()
        run: gh issue close ${{ github.event.issue.number }} -c "‚ùó ${{ env.error }}"

      - name: Validation success
        run: gh issue comment ${{ github.event.issue.number }} -b "‚≠ê Branch validation success"

      - name: Set environments envs to work
        run: |
          environments="${{ steps.issue-parser.outputs.issueparser_environments }}"
          IFS=, read -ra EnvironmentArray <<< "$environments"

          for environment in "${EnvironmentArray[@]}"; do
            environment=$(echo "$environment" | xargs)

            echo "${environment}=${environment}" >> $GITHUB_ENV
          done

          if [ -n "${{ steps.issue-parser.outputs.issueparser_shouldRemove }}" ]; then
            echo "shouldRemove=true" >> $GITHUB_ENV
          fi

      - name : Create new environments branches
        env:
          GIT_COMMITTER_NAME: GitHub Actions
          GIT_COMMITTER_EMAIL: actions@github.com
        run: |

          if [ "${{ env.develop }}" ]; then
            echo "Starting new branch develop"
            git checkout master
            ./.github/support/handle-environments-branches.sh develop

            git checkout master
            ./.github/support/build-environments-branches.sh develop

            gh issue comment ${{ github.event.issue.number }} -b "üëç Branch **develop** updated"
          fi

          if [ "${{ env.homolog }}" ]; then
           echo "Starting new branch homolog"
            rm -rf error.log
            git checkout master
            ./.github/support/handle-environments-branches.sh homolog

            git checkout master
            ./.github/support/build-environments-branches.sh homolog

            gh issue comment ${{ github.event.issue.number }} -b "üëç Branch **homolog** updated"
          fi

          if [ "${{ env.staging }}" ]; then
            echo "Starting new branch staging"
            rm -rf error.log
            git checkout master
            ./.github/support/handle-environments-branches.sh staging

            git checkout master
            ./.github/support/build-environments-branches.sh staging

            gh issue comment ${{ github.event.issue.number }} -b "üëç Branch **staging** updated"
          fi

      - name: Send error feedback and close issue
        if: failure() && !cancelled()
        run: gh issue close ${{ github.event.issue.number }} -c "‚ùó$(cat error.log)"

      - name: Branches updated with success
        run: |
          if [ -n "${{ env.shouldRemove }}" ]; then
            allBranches="${{ env.validatedIssueBranches }}"
            IFS=, read -ra BranchArray <<< "$allBranches"

            comment_message="üöΩ Branches removed successfully!

            The following branches have been removed:"
            for branch in "${BranchArray[@]}"; do
            comment_message+="
              - $branch"
            done

            gh issue close ${{ github.event.issue.number }} -c "$comment_message"
          else
            allBranches="${{ env.validatedIssueBranches }},${{ env.validatedBranches }}"

            IFS=, read -ra BranchArray <<< "$allBranches"

            comment_message="‚ö° Branches updated successfully!

            The new branches contents:"
            for branch in "${BranchArray[@]}"; do
            comment_message+="
              - $branch"
            done

            gh issue close ${{ github.event.issue.number }} -c "$comment_message"
          fi

