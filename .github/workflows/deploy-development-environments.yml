name: Deploy by issue
permissions: write-all
on:
  issues:
    types: [opened]

jobs:
  deploy:
    if: contains(github.event.issue.labels.*.name, 'environment-deploy')
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Assign issue
        run: |
          gh issue edit ${{ github.event.issue.number }} --add-assignee ${{ github.event.issue.user.login }}
          gh issue comment ${{ github.event.issue.number }} -b "
            ‚åõ To follow the runner click here:
            - https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Parse issue
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/deploy-environments.yml

      - name: Issue branch validation
        run: |
            validatedIssueBranches=""
            branches="${{ steps.issue-parser.outputs.issueparser_branches }}"
            IFS=',' read -ra branch_array <<< "$branches"

            for branch in "${branch_array[@]}"; do
              set +e
              git ls-remote --exit-code --heads origin $branch &> /dev/null
              branch_exists=$?

              if [[ "$branch_exists" == "0" ]]; then
                git checkout $branch &> /dev/null
                git log --pretty=format:"%h" develop | grep `git log --pretty=format:"%h" -1 $branch` &> /dev/null
                branch_merged=$?

                if [[ "$branch_merged" == "0" ]]; then
                  echo "error= üí¢ The **$branch** exists, but has already been merged." >> $GITHUB_ENV
                  set -e
                  exit 1
                else
                  validatedIssueBranches+="$branch,"
                  echo "validatedIssueBranches=${validatedIssueBranches%,}" >> $GITHUB_ENV
                fi
                else
                  echo "error= üí¢ The **$branch** non exists." >> $GITHUB_ENV
                  set -e
                  exit 1
              fi
            done

      - name: Close issue
        if: failure() && !cancelled()
        run: gh issue close ${{ github.event.issue.number }} -c "‚ùó ${{ env.error }}"

      - name: Validation success
        run: gh issue comment ${{ github.event.issue.number }} -b "‚≠ê Branch validation success"

      - name : Create new environments branches
        env:
          GIT_COMMITTER_NAME: GitHub Actions
          GIT_COMMITTER_EMAIL: actions@github.com
        run: |

          shouldRemove="${{ steps.issue-parser.outputs.issueparser_shouldRemove }}"
          environments="${{ steps.issue-parser.outputs.issueparser_environments }}"
          IFS=, read -ra EnvironmentArray <<< "$environments"

          for environment in "${EnvironmentArray[@]}"; do
             rm -rf error.log
            environment=$(echo "$environment" | xargs)

            echo "Starting new branch $environment"
            git checkout master

            ./.github/support/handle-environments-branches.sh $environment $shouldRemove

            comment_message="‚ö° Branch **$environment** updated!

            The new branches contents:"

              while IFS=, read -ra branches; do
                for branch in "${branches[@]}"; do
                  comment_message+="
                    - $branch"
                done
              done < ./.github/support/"$environment"-branches.txt

            gh issue comment ${{ github.event.issue.number }} -b "$comment_message"
          done

      - name: Send error feedback and close issue
        if: failure() && !cancelled()
        run: gh issue close ${{ github.event.issue.number }} -c "‚ùó$(cat error.log)"

      - name: Branches updated with success
        run: gh issue close ${{ github.event.issue.number }} -c "‚ö° Branches updated successfully!"

